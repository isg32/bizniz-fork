<header
    x-data="{ mobileMenuOpen: false, userMenuOpen: false }"
    class="fixed lg:top-4 lg:left-1/2 lg:-translate-x-1/2 z-[112] w-full lg:max-w-fit mx-auto lg:rounded-[12px] transition-all duration-[250ms] ease-[cubic-bezier(0.4,0,0.2,1)] will-change-[background-color,border-color,box-shadow,backdrop-filter] lg:border border-white/20 bg-gradient-to-r from-[rgba(249,250,247,0.12)] to-[rgba(249,250,247,0.18)] lg:shadow-[0_2px_6px_0_rgba(0,0,0,0.15)] backdrop-blur-[9px]"
    style="
        background-color: var(--bg-surface/90);
        border-bottom: 1px solid var(--border-color/90);
    "
>
    <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
            <!-- Logo & Main Nav -->
            <div class="flex items-center">
                <a
                    href="/"
                    class="flex-shrink-0 flex items-center gap-2 text-xl font-bold text-slate-800"
                >
                    <i class="fa-solid fa-brain text-indigo-600"></i>
                    <span style="color: var(--text-color)"
                        >{{ settings.PROJECT_NAME }}</span
                    >
                </a>
                <button
                    @click="toggleTheme"
                    type="button"
                    class="toggle-button p-2 rounded-full text-slate-700 hover:text-indigo-600 transition-colors duration-200"
                    :style="{ 'color': isDark ? 'var(--text-color)' : 'var(--text-secondary)' }"
                >
                    <span x-show="!isDark" class="sr-only"
                        >Enable Dark Mode</span
                    >
                    <i x-show="!isDark" class="fa-solid fa-moon text-lg"></i>
                    <span x-show="isDark" class="sr-only"
                        >Enable Light Mode</span
                    >
                    <i
                        x-show="isDark"
                        class="fa-solid fa-sun text-lg text-amber-500"
                    ></i>
                </button>
                <div class="hidden lg:flex lg:ml-10 lg:space-x-8">
                    <a
                        href="/pricing"
                        style="color: var(--text-color-secondary)"
                        class="text-slate-600 hover:text-indigo-600 font-medium"
                        >Pricing</a
                    >
                    <a
                        href="/agents"
                        style="color: var(--text-color-secondary)"
                        class="text-slate-600 hover:text-indigo-600 font-medium"
                        >Agents</a
                    >
                    <a
                        href="https://github.com/bugswriter"
                        target="_blank"
                        style="color: var(--text-color-secondary)"
                        class="text-slate-600 hover:text-indigo-600 font-medium"
                        >Contact</a
                    >
                </div>
            </div>

            <!-- Right side actions -->
            <div class="flex items-center gap-4">
                {% if current_user %}
                <div
                    class="hidden sm:flex items-center gap-2 text-sm font-semibold text-slate-600"
                >
                    <i class="fa-solid fa-coins text-amber-500"></i>
                    <span>{{ "%.0f"|format(current_user.coins|float) }}</span>
                </div>
                <!-- Profile dropdown -->
                <div class="relative ml-3">
                    <div>
                        <button
                            @click="userMenuOpen = !userMenuOpen"
                            type="button"
                            class="flex text-sm bg-slate-200 rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                            id="user-menu-button"
                        >
                            <span class="sr-only">Open user menu</span>

                            <!-- MODIFICATION START: Conditional Avatar Display -->
                            {% if current_user.avatar %}
                            <img
                                class="h-8 w-8 rounded-full object-cover"
                                src="{{ current_user.avatar }}"
                                alt="User Avatar"
                            />
                            {% else %}
                            <div
                                class="w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center"
                            >
                                <span class="text-sm font-bold"
                                    >{{ current_user.name[0]|upper if
                                    current_user.name else 'U' }}</span
                                >
                            </div>
                            {% endif %}
                            <!-- MODIFICATION END -->
                        </button>
                    </div>
                    <div
                        x-show="userMenuOpen"
                        @click.away="userMenuOpen = false"
                        x-transition:enter="transition ease-out duration-100"
                        x-transition:enter-start="transform opacity-0 scale-95"
                        x-transition:enter-end="transform opacity-100 scale-100"
                        x-transition:leave="transition ease-in duration-75"
                        x-transition:leave-start="transform opacity-100 scale-100"
                        x-transition:leave-end="transform opacity-0 scale-95"
                        class="origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white ring-1 ring-black ring-opacity-5 focus:outline-none"
                        style="display: none"
                    >
                        <a
                            href="/dashboard"
                            class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100"
                            >Dashboard</a
                        >
                        <a
                            href="/pricing"
                            class="block sm:hidden px-4 py-2 text-sm text-slate-700 hover:bg-slate-100"
                            >Buy Coins</a
                        >
                        <div class="my-1 h-px bg-slate-100"></div>
                        <a
                            href="/logout"
                            class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100"
                            >Logout</a
                        >
                    </div>
                </div>
                {% else %}
                <div class="hidden lg:flex items-center gap-2">
                    <a
                        href="/login"
                        style="color: var(--text-color-secondary)"
                        class="px-4 py-2 text-sm font-semibold text-slate-600 hover:text-indigo-600"
                        >Log In</a
                    >
                    <a
                        href="/register"
                        class="px-4 py-2 text-sm font-semibold text-white bg-indigo-600 rounded-md hover:bg-indigo-700 shadow-sm"
                        >Get Started</a
                    >
                </div>
                {% endif %}

                <!-- Mobile menu button -->
                <div class="lg:hidden">
                    <button
                        @click="mobileMenuOpen = !mobileMenuOpen"
                        type="button"
                        class="inline-flex items-center justify-center p-2 rounded-md text-slate-400 hover:text-slate-500 hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500"
                    >
                        <span class="sr-only">Open main menu</span>
                        <i
                            class="fa-solid fa-bars"
                            :class="{ 'hidden': mobileMenuOpen, 'block': !mobileMenuOpen }"
                        ></i>
                        <i
                            class="fa-solid fa-xmark"
                            :class="{ 'hidden': !mobileMenuOpen, 'block': mobileMenuOpen }"
                        ></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile menu, show/hide based on menu state. -->
    <div
        x-show="mobileMenuOpen"
        class="lg:hidden h-dvh bg-white flex justify-between flex-col"
        style="display: none; background: var(--bg-color)"
    >
        <div class="space-y-6 sm:px-3"></div>
        <div class="px-4 space-y-6 sm:px-3 text-white text-center">
            <a
                href="/pricing"
                class="block px-3 py-2 rounded-md text-5xl font-medium"
                >Pricing</a
            >
            <a
                href="/Agents"
                class="block px-3 py-2 rounded-md text-5xl font-medium"
                >Agents</a
            >
            <a
                href="https://github.com/bugswriter"
                target="_blank"
                class="block px-3 py-2 rounded-md text-5xl font-medium"
                >Contact</a
            >
        </div>
        {% if not current_user %}
        <div
            class="pb-24 pt-6 border-t"
            style="border-color: var(--text-color) / 20"
        >
            <div class="flex gap-2 items-center px-5">
                <a
                    href="/login"
                    class="w-full border rounded-md text-center px-4 py-2 text-base font-semibold"
                    style="
                        border-color: var(--text-color);
                        color: var(--text-color);
                    "
                    >Log In</a
                >
                <a
                    href="/register"
                    class="w-full text-center px-4 py-2 text-base font-semibold text-white bg-indigo-600 rounded-md shadow-sm"
                    >Get Started</a
                >
            </div>
        </div>
        {% endif %}
    </div>
</header>
